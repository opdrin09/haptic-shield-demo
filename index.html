<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HapticShield v2</title>
    <style>
        /* Design Industrial Dark */
        :root { --neon: #0f0; --danger: #f00; --bg: #111; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: monospace; color: var(--neon); user-select: none; }
        
        /* Câmera no Fundo */
        #cam-feed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0.6; filter: grayscale(100%); }
        
        /* Interface */
        #hud { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        
        .top-hud { border-bottom: 1px solid var(--neon); padding-bottom: 10px; background: rgba(0,0,0,0.6); }
        .data-row { display: flex; justify-content: space-between; font-size: 1.2rem; margin-top: 5px; }
        .label { font-size: 0.7rem; color: #aaa; }

        /* Barra de Vida */
        .health-wrap { margin: 20px 0; background: #222; border: 2px solid #555; height: 30px; position: relative; }
        .health-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #0f0, #ff0); transition: width 0.2s; }
        .health-txt { position: absolute; width: 100%; text-align: center; top: 5px; color: #000; font-weight: bold; font-size: 0.8rem; }

        /* Botão Principal */
        .btn-area { display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
        #main-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: rgba(0, 50, 0, 0.5); border: 3px solid var(--neon);
            color: var(--neon); font-weight: bold; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px var(--neon); cursor: pointer;
        }
        #main-btn:active { background: var(--neon); color: #000; transform: scale(0.95); }
        
        /* Botão de Teste Debug */
        #debug-btn { margin-bottom: 20px; padding: 5px 10px; background: #333; border: 1px solid #fff; color: #fff; font-size: 0.7rem; }

        /* Telas */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:100; display:flex; align-items:center; justify-content:center; flex-direction:column; }
        .hidden { display: none !important; }
        .red-flash { animation: flash 0.5s infinite; }
        @keyframes flash { 0%{background:rgba(255,0,0,0)} 50%{background:rgba(255,0,0,0.5)} 100%{background:rgba(255,0,0,0)} }
    </style>
</head>
<body>

    <video id="cam-feed" autoplay playsinline muted></video>
    <div id="flash-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5;"></div>

    <div id="start-screen" class="overlay">
        <h1>HAPTIC SHIELD</h1>
        <p>Monitoramento VMB</p>
        <button onclick="startSystem()" style="padding:15px; font-size:1.2rem; background:var(--neon); border:none; font-weight:bold; margin-top:20px;">INICIAR SISTEMA</button>
        <p style="font-size:0.7rem; color:#666; margin-top:20px;">Ative o som e a vibração do celular</p>
    </div>

    <div id="hud" class="hidden">
        <div class="top-hud">
            <div class="label">SISTEMA ATIVO</div>
            <div class="data-row">
                <span>ACELERAÇÃO:</span>
                <span id="acc-display">0.0 m/s²</span>
            </div>
            <div class="data-row">
                <span>EXPOSIÇÃO A(8):</span>
                <span id="dose-display">0.00</span>
            </div>
        </div>

        <div class="health-wrap">
            <div class="health-fill" id="hp-bar"></div>
            <div class="health-txt">SAÚDE VASCULAR</div>
        </div>

        <div class="btn-area">
            <button id="debug-btn" onclick="testVib()">TESTAR VIBRAÇÃO (DEBUG)</button>
            <div id="main-btn">OPERAR</div>
        </div>
    </div>

    <script>
        // Variáveis
        let hp = 100;
        let dose = 0;
        let interval;
        let vibInterval;
        const mainBtn = document.getElementById('main-btn');
        const hpBar = document.getElementById('hp-bar');
        const flash = document.getElementById('flash-layer');

        // 1. Iniciar Câmera (Com Try/Catch para não travar se falhar)
        async function startSystem() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('cam-feed').srcObject = stream;
            } catch (err) {
                console.log("Câmera falhou ou negada. Seguindo sem ela.");
                document.getElementById('cam-feed').style.display = 'none';
                document.body.style.background = "#111"; // Fundo cinza se não tiver câmera
            }
        }

        // 2. Função de Teste Simples
        function testVib() {
            if (navigator.vibrate) {
                navigator.vibrate(500); // Vibra por meio segundo
                alert("Comando enviado! Se não vibrou, verifique as configurações do Android.");
            } else {
                alert("Seu navegador não suporta vibração (iOS ou Bloqueado).");
            }
        }

        // 3. Operação da Ferramenta
        function startTool(e) {
            if(e) e.preventDefault();
            if(hp <= 0) return;

            mainBtn.style.background = "#f00";
            mainBtn.innerText = "ON";
            
            // Vibração em Loop (Melhor compatibilidade)
            if (navigator.vibrate) {
                // Padrão: Vibra 200ms, Para 50ms (Parece uma britadeira)
                navigator.vibrate([200, 50, 200, 50, 200, 50, 200, 50, 200]); 
                vibInterval = setInterval(() => {
                    navigator.vibrate([200, 50]); 
                }, 250);
            }

            // Loop de Dados
            interval = setInterval(() => {
                // Atualizar Dose
                dose += 0.05; 
                document.getElementById('dose-display').innerText = dose.toFixed(2);
                
                // Atualizar Aceleração (Random entre 15 e 20)
                let r = (15 + Math.random() * 5).toFixed(1);
                document.getElementById('acc-display').innerText = r + " m/s²";

                // Dano
                hp -= 0.8;
                hpBar.style.width = hp + "%";

                // Cores
                if(hp < 50) hpBar.style.background = "orange";
                if(hp < 20) {
                    hpBar.style.background = "red";
                    flash.classList.add('red-flash');
                }
                if(hp <= 0) {
                    stopTool();
                    alert("FALHA CRÍTICA: DANO VASCULAR PERMANENTE.\nNorma ISO 5349 violada.");
                    hp = 0;
                }
            }, 100);
        }

        function stopTool(e) {
            if(e) e.preventDefault();
            mainBtn.style.background = "rgba(0, 50, 0, 0.5)";
            mainBtn.innerText = "OPERAR";
            flash.classList.remove('red-flash');
            document.getElementById('acc-display').innerText = "0.0 m/s²";

            clearInterval(interval);
            clearInterval(vibInterval);
            if(navigator.vibrate) navigator.vibrate(0); // Parar forçado
        }

        // Eventos de Toque e Mouse
        mainBtn.addEventListener('mousedown', startTool);
        mainBtn.addEventListener('mouseup', stopTool);
        mainBtn.addEventListener('mouseleave', stopTool);
        mainBtn.addEventListener('touchstart', startTool);
        mainBtn.addEventListener('touchend', stopTool);

    </script>
</body>
</html>
